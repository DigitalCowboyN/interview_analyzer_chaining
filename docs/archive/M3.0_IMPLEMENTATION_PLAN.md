# M3.0 Implementation Plan: Remove Dual-Write

> **Created:** 2026-01-18
> **Status:** In Progress

## Overview

Remove direct Neo4j writes from pipeline. Projection service becomes the SOLE writer to Neo4j.

## Tasks Checklist

### Phase 1: Delete Legacy Tests
- [ ] Delete `tests/integration/test_neo4j_analysis_writer_legacy.py` (27 tests, 1403 lines)

### Phase 2: Remove Direct Neo4j Writes from Pipeline
- [ ] Remove `save_analysis_to_graph()` import from `src/pipeline.py` (line 60)
- [ ] Remove `_handle_graph_save()` method from `src/pipeline.py` (lines ~230-256)
- [ ] Remove call to `_handle_graph_save()` in result saving loop (lines ~456-458)
- [ ] Delete `save_analysis_to_graph()` function from `src/persistence/graph_persistence.py` (lines 15-173)

### Phase 3: Clean Up Neo4j Writers
- [ ] Remove dead code `_run_write_entry_queries()` from `src/io/neo4j_map_storage.py` (lines 186-273)
- [ ] Remove deprecation warnings from `src/io/neo4j_analysis_writer.py` (lines 47-59)
- [ ] Remove deprecation warnings from `src/io/neo4j_map_storage.py` (lines 42-54)
- [ ] Simplify error handling in `neo4j_analysis_writer.py` (remove direct write fallback)

### Phase 4: Upgrade neo4j Driver
- [ ] Update `requirements.txt`: neo4j 5.28.1 â†’ 6.x
- [ ] Update `docker-compose.yml`: neo4j image version
- [ ] Test compatibility with `src/utils/neo4j_driver.py`
- [ ] Run full test suite

### Phase 5: Documentation & Cleanup
- [ ] Update ROADMAP.md
- [ ] Update architecture docs
- [ ] Commit and push

## Files to Modify

| File | Action |
|------|--------|
| `tests/integration/test_neo4j_analysis_writer_legacy.py` | DELETE |
| `src/persistence/graph_persistence.py` | Remove `save_analysis_to_graph()` |
| `src/pipeline.py` | Remove direct Neo4j writes |
| `src/io/neo4j_map_storage.py` | Remove dead code |
| `src/io/neo4j_analysis_writer.py` | Remove deprecation warnings |
| `requirements.txt` | Upgrade neo4j |
| `docker-compose.yml` | Upgrade neo4j image |

## Key Code Locations

### Pipeline Direct Writes (to remove)
```
src/pipeline.py:60      - import save_analysis_to_graph
src/pipeline.py:230-256 - _handle_graph_save() method
src/pipeline.py:456-458 - call to _handle_graph_save()
```

### Graph Persistence (to remove)
```
src/persistence/graph_persistence.py:15-173 - save_analysis_to_graph()
```

### Dead Code in Writers
```
src/io/neo4j_map_storage.py:186-273 - _run_write_entry_queries()
```

## Test Commands

```bash
# Run remaining Neo4j integration tests
docker compose run --rm app python -m pytest tests/integration/test_neo4j_*.py -v --no-cov

# Run projection tests
docker compose run --rm app python -m pytest tests/projections/ -v --no-cov

# Run full test suite
docker compose run --rm app python -m pytest --no-cov
```
