# M2.3-M2.8 Execution Plan (Option A: Immediate Transition)

**Date:** 2026-01-10
**Status:** ğŸš€ EXECUTING
**Approach:** Validate technically, transition immediately (greenfield context)

---

## Executive Decision: Option A Selected

**Rationale:**
- Greenfield application - no production traffic to monitor
- Projection service code already complete (M2.3-M2.7 built)
- 740 tests already passing - comprehensive coverage
- Clean CQRS architecture from day 1 (no dual-write complexity)
- Events are immutable - can rebuild if issues found

**Timeline:** Same day completion

---

## Phase 1: Write Integration Tests (2-3 hours)

### Test 1: Projection Deduplication During Dual-Write

**File:** `tests/integration/test_projection_dual_write_validation.py`

**Purpose:** Verify projection service correctly handles dual-write scenario (no duplicates)

**Test Logic:**
```python
async def test_projection_service_deduplicates_during_dual_write():
    """
    Scenario:
    1. Pipeline processes file â†’ creates events + direct writes to Neo4j
    2. Projection service processes same events â†’ should update, not duplicate

    Validation:
    - Only 1 Sentence node exists per sentence (no duplicates)
    - event_version updated from 0 (direct) to N (projection)
    - source updated from "pipeline_direct" to "projection_service"
    """
```

**Success Criteria:**
- No duplicate nodes created
- Version tracking works correctly
- MERGE logic prevents conflicts

---

### Test 2: Projection Rebuild from Events

**File:** `tests/integration/test_projection_rebuild.py`

**Purpose:** Verify projection service can rebuild Neo4j from scratch using only events

**Test Logic:**
```python
async def test_projection_service_rebuilds_neo4j_from_events():
    """
    Scenario:
    1. Pipeline processes file â†’ creates events + direct writes
    2. Capture original Neo4j state (nodes, relationships, properties)
    3. Delete ALL Neo4j nodes
    4. Start projection service â†’ replay all events
    5. Compare rebuilt state with original state

    Validation:
    - All Interview nodes recreated
    - All Sentence nodes recreated
    - All relationships recreated
    - Properties match (except event_version, source, timestamps)
    """
```

**Success Criteria:**
- Complete rebuild from events
- State matches original (functionally equivalent)
- No data loss

---

### Test 3: Metrics Integration

**File:** `tests/integration/test_dual_write_metrics.py`

**Purpose:** Verify all dual-write metrics increment correctly

**Test Logic:**
```python
async def test_dual_write_metrics_track_correctly():
    """
    Scenario:
    1. Clear/reset metrics
    2. Process file through pipeline (successful dual-write)
    3. Verify metrics incremented:
       - event_emission_success_total
       - dual_write_event_first_success_total
       - dual_write_neo4j_after_event_success_total
    4. Simulate event failure
    5. Verify failure metrics incremented:
       - event_emission_failure_total
       - dual_write_event_first_failure_total
    6. Simulate Neo4j failure after event success
    7. Verify metrics:
       - event_emission_success_total (increments)
       - dual_write_neo4j_after_event_failure_total (increments)

    Validation:
    - All metrics track correctly
    - Counters increment appropriately
    - Metrics observable for monitoring
    """
```

**Success Criteria:**
- Metrics track all scenarios
- Counters accurate
- Observable for production monitoring

---

## Phase 2: Run Comprehensive Test Suite (30 minutes)

### Test Execution

```bash
# Run all tests including new integration tests
docker compose run --rm app pytest tests/ \
    --ignore=tests/integration/test_projection_replay.py \
    --ignore=tests/integration/test_idempotency.py \
    --ignore=tests/integration/test_performance.py \
    -v

# Expected results:
# - 743+ tests passed (740 existing + 3 new)
# - 13 skipped
# - 0 failed
```

### Validation Criteria

**Must Pass:**
- âœ… All 740 existing tests pass
- âœ… All 3 new integration tests pass
- âœ… No regressions introduced
- âœ… Coverage remains >74%

**If Any Failures:**
- Debug and fix issues
- Re-run test suite
- Repeat until all tests pass

---

## Phase 3: Transition to M2.8 (1-2 hours)

### Step 1: Remove Direct Neo4j Writes

#### File 1: `src/io/neo4j_map_storage.py`

**Keep:**
```python
# Event emission code (STEP 1)
if self.event_emitter:
    await self.event_emitter.emit_sentence_created(...)
```

**Remove:**
```python
# STEP 2: Direct Neo4j write code
async with await Neo4jConnectionManager.get_session() as session:
    await self._run_write_entry_queries(session, entry)
```

**Rationale:** Events only, projection service handles Neo4j writes

---

#### File 2: `src/io/neo4j_analysis_writer.py`

**Keep:**
```python
# Event emission code (STEP 1)
if self.event_emitter and not is_error_result:
    await self.event_emitter.emit_analysis_generated(...)
```

**Remove:**
```python
# STEP 2: Direct Neo4j write code
async with await Neo4jConnectionManager.get_session() as session:
    await self._write_analysis_to_neo4j(...)
```

**Handle Error Results:**
```python
# Error results still need to be written somewhere
# Keep Neo4j write for error results (no events for errors)
if is_error_result:
    # Write error result directly to Neo4j
    async with await Neo4jConnectionManager.get_session() as session:
        await self._write_error_result(session, result)
```

**Rationale:**
- Successful analyses: Events â†’ Projection service â†’ Neo4j
- Error results: Direct to Neo4j (no events emitted for errors)

---

#### File 3: `src/pipeline.py`

**Keep:**
```python
# InterviewCreated event emission
await self.event_emitter.emit_interview_created(...)
```

**Note:** Pipeline doesn't directly write Interview nodes to Neo4j (already event-only)

---

### Step 2: Update Configuration

#### File: `src/config.py` (if needed)

**Add M2.8 mode flag:**
```python
"projection": {
    "mode": "m2.8",  # Single-writer mode
    "dual_write_enabled": False
}
```

**Or:** Simply remove dual-write code (cleaner)

---

### Step 3: Update Tests

#### Tests to Update:
- `tests/integration/test_neo4j_map_storage.py`
- `tests/integration/test_neo4j_analysis_writer.py`
- `tests/integration/test_dual_write_pipeline.py`

**Changes:**
- Remove expectations for direct Neo4j writes
- Verify only events are emitted
- Update tests to use projection service for validating Neo4j state

**Example:**
```python
# Before (M2.2 dual-write):
await storage.write_entry(entry)
# Expect: Event emitted AND Neo4j written

# After (M2.8 single-writer):
await storage.write_entry(entry)
# Expect: Event emitted ONLY
# Neo4j validation requires projection service
```

---

### Step 4: Update Documentation

#### Files to Update:
1. `README.md` - Update architecture diagram
2. `docs/ARCHITECTURE.md` - Document M2.8 architecture
3. `docs/DEPLOYMENT.md` - Update deployment instructions

**Key Points:**
- Pipeline: Command side (events only)
- Projection Service: Query side (Neo4j writes)
- Clean CQRS separation
- Events as single source of truth

---

## Phase 4: Validation (30 minutes)

### Run Full Test Suite Again

```bash
docker compose run --rm app pytest tests/ \
    --ignore=tests/integration/test_projection_replay.py \
    --ignore=tests/integration/test_idempotency.py \
    --ignore=tests/integration/test_performance.py \
    -v
```

**Expected:**
- All tests pass (may be fewer tests after removing dual-write tests)
- No regressions
- Clean architecture

---

### Manual Validation

```bash
# 1. Start projection service
docker compose up projection-service

# 2. Process a test file
docker compose run --rm app python -m src.run_pipeline \
    --input data/input/test.txt \
    --output /tmp/output

# 3. Verify EventStoreDB has events
# Check streams: Interview-*, Sentence-*

# 4. Verify Neo4j has data (written by projection service)
# Query: MATCH (i:Interview)-[:HAS_SENTENCE]->(s:Sentence) RETURN i, s

# 5. Verify source field
# All nodes should have source="projection_service"
```

---

## Success Criteria

### Phase 1: Integration Tests
- âœ… Test 1: Deduplication test written and passing
- âœ… Test 2: Rebuild test written and passing
- âœ… Test 3: Metrics test written and passing

### Phase 2: Test Suite
- âœ… All 743+ tests passing
- âœ… 0 failures
- âœ… Coverage >74%

### Phase 3: M2.8 Transition
- âœ… Direct Neo4j writes removed from pipeline
- âœ… Event emission code preserved
- âœ… Error handling for non-evented scenarios preserved
- âœ… Tests updated for M2.8 architecture
- âœ… Documentation updated

### Phase 4: Validation
- âœ… Full test suite passes after M2.8 transition
- âœ… Manual validation successful
- âœ… Projection service writes to Neo4j correctly
- âœ… Events are sole source of truth

---

## Rollback Plan

**If Issues Found:**

1. **Revert Git commits** from M2.8 transition
2. **Return to M2.2** (dual-write mode)
3. **Debug issues** with projection service
4. **Fix and re-test**
5. **Retry M2.8 transition** when ready

**Confidence Level:** HIGH
- 740+ tests already passing
- Projection service code already built
- Comprehensive test coverage
- Events are immutable (can always rebuild)

---

## Timeline

| Phase | Task | Duration | Status |
|-------|------|----------|--------|
| 1 | Write Test 1: Deduplication | 45 min | ğŸ”„ NEXT |
| 1 | Write Test 2: Rebuild | 45 min | â³ PENDING |
| 1 | Write Test 3: Metrics | 45 min | â³ PENDING |
| 2 | Run Test Suite | 30 min | â³ PENDING |
| 3 | Remove Direct Writes | 45 min | â³ PENDING |
| 3 | Update Tests | 30 min | â³ PENDING |
| 3 | Update Documentation | 15 min | â³ PENDING |
| 4 | Final Validation | 30 min | â³ PENDING |
| **Total** | | **~4 hours** | |

---

## Risks & Mitigation

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|-----------|
| Projection service has undiscovered bug | LOW | HIGH | Comprehensive test coverage, events allow rebuild |
| Integration tests reveal issues | MEDIUM | MEDIUM | Debug and fix before M2.8 transition |
| Tests fail after M2.8 transition | LOW | MEDIUM | Rollback plan ready, git revert |
| Performance issues with projection-only | LOW | MEDIUM | Already tested in dual-write mode |

---

## Post-Completion

### Deployment Architecture (M2.8)

```
User Request
    â†“
Pipeline (Command Side)
    â”œâ”€â”€â†’ Emit Events to EventStoreDB
    â””â”€â”€â†’ Return success

EventStoreDB (Source of Truth)
    â†“
Projection Service (Query Side)
    â”œâ”€â”€â†’ Subscribe to events
    â”œâ”€â”€â†’ Process events
    â””â”€â”€â†’ Write to Neo4j

Neo4j (Read Model)
    â†“
API Queries
```

**Benefits:**
- âœ… Clean CQRS separation
- âœ… Events as single source of truth
- âœ… Neo4j can be rebuilt anytime
- âœ… Simpler codebase (no dual-write)
- âœ… Easier to reason about

---

## Sign-Off

**Plan Approved:** âœ…
**Ready to Execute:** âœ…
**Timeline:** Same day completion
**Risk Level:** LOW (comprehensive testing, rollback plan ready)

---

**Next Action:** Begin Phase 1 - Write integration tests
